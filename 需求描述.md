你这版“侧躺检测”之所以会明显误判，根因其实在**“侧躺”与“手机姿态”不是一一对应**：只看手机的加速度/重力方向，很多**正常使用（坐着/站着/靠着）**也会满足你当前的“侧躺”判定条件，所以默认算法会把“手机不平放”≈“侧躺”。你文档里的默认规则确实是这种倾向：`abs(avgNz) < 0.8` 且 `abs(avgNx)>0.4 || abs(avgNy)>0.4`，再加上原始值兜底 `abs(ax)>6.5 && abs(az)<5.0`，本质上更像在检测“手机偏竖、重力落在侧边”而不是“人侧躺”。

下面我分两块给你建议：先把“什么是侧躺/什么是正确姿势”讲清楚，再**结合你现有实现**（指数平滑、滑窗、运动重置、自定义姿势相似度等）给出一套能落地的优化方案。

---

## 1) 先定义：你要检测的到底是什么

### A. “侧躺”在体验层面的定义（建议你在产品里用“风险姿势”表述）

严格意义的侧躺是**人的躯干侧卧 + 头部侧偏/旋转**。但你当前传感器主要在手机上，所以更现实的目标是检测：

* **高风险用机姿势**：用户在床上/沙发上“躺用”，导致**头颈偏转**、**两眼到屏幕距离不一致**、**屏幕与视线夹角过大**等（这些是用户体感不适/疲劳更相关的因素）。
* 这类风险姿势与手机姿态“相关但不等价”：有人侧躺也能把手机举到很正；有人坐着也能把手机歪到很侧。

**结论**：如果你只用手机 IMU（加速度/陀螺仪），更推荐把功能定义成

> “检测可能的躺用/歪头用机风险”，而不是“精准识别人体侧躺”。

### B. “正确玩手机姿势”你可以在引导页里这么说（不需要医学化）

* **身体**：尽量坐直或半躺但保持头颈居中，避免长时间歪头。
* **手机位置**：屏幕中心略低于视线、手机在正前方，尽量减少“扭头看屏”。
* **视线与屏幕**：理想状态是**视线尽量接近屏幕法线方向（接近垂直看屏）**，而不是从很斜的角度“侧着看”。
* **时间**：比“姿势是否标准”更重要的是“持续多久”，你现在也正是靠持续时间提醒（`thresholdSeconds`）在做体验闭环。

---

## 2) 结合你现有实现，给一套“显著降误判”的改造路线

你当前管线的亮点是：

* 有指数平滑（α=0.15）降低抖动
* 有剧烈运动重置（`deltaG > 2.0`）避免翻身残留
* 有滑窗+连续计数做状态稳定（3 次入、5 次出）
* 有自定义姿势匹配（加权欧氏距离 + 阈值 0.5） 

误判主要来自**“默认判定特征不够区分”**和**“缺少使用场景 gating（门控）”**。按投入产出，我建议你按优先级做 3 层改造：

---

# 第一层（最值）：把“侧躺判定”从阈值堆砌，换成“角度 + 滞回 + 时间”

## 2.1 用“roll/pitch 角度”替代当前 `abs(nx/ny/nz)` 的组合阈值

你现在是把重力向量归一化得到 `nx/ny/nz` 并平滑。在此基础上直接算角度更直观：

* `roll = atan2(avgNy, avgNz)`
* `pitch = atan2(-avgNx, sqrt(avgNy^2 + avgNz^2))`

然后用角度定义“可能躺用风险”：

* **风险进入阈值**（示例）：`|roll| > 55°` 且 `|pitch| < 35°`
* **风险退出阈值**（滞回）：`|roll| < 40°` 或 `|pitch| > 45°`

> 你当前“入 3 出 5”的连续计数本质是稳定器，但如果底层特征不区分，稳定器只会“稳定地误判”。角度 + 滞回会显著减少“拿手机竖着看却被判侧躺”的情况。

## 2.2 把“连续次数”改成“连续时间”（因为你前后台采样率不同）

你前台约 50Hz，后台约 15Hz。同样的“连续 3 次”，在前台可能是 60ms，在后台可能是 200ms，体验会漂。

建议：

* 用 `enterHoldMs`（比如 800–1200ms）确认进入
* 用 `exitHoldMs`（比如 1200–2000ms）确认退出

实现方式很简单：仍然保留你滑窗思路，但把计数器换成累计毫秒（基于事件时间戳）。

---

# 第二层（降误判杀手锏）：加“场景门控（gating）”，只在“用户确实在用手机”时判定

你现在只要服务在跑就采样判定，这会导致很多误判来自：

* 手机放床上但屏幕亮/息屏切换
* 用户拿着手机走动/换姿势
* 车上/地铁晃动
* 只是“歪拿手机”但没有歪头躺用

建议加 3 个门控条件（满足其一或其二即可开始“风险判定”，否则直接 `isSide=false`，并清空候选计时）：

## 2.3 “使用中”门控

* 屏幕亮 + 解锁（PowerManager / Keyguard）
* 最近 N 秒内有触摸/滚动（Flutter 端很好拿，原生也可从悬浮窗交互/前台 activity 侧拿）

如果**不在使用中**：不要做侧躺检测（否则床头放置会误判）。

## 2.4 “近脸”门控（可选但很有效）

* 用 **距离传感器（proximity）**：靠近脸时一般会触发（不同机型需适配），或者做“近距离权重更高”。
  这能把“手机放在旁边/桌上”过滤掉很多。

## 2.5 “低线性运动”门控

你已有 `deltaG > 2.0` 就重置，但日常走路晃动可能不足 2.0，仍会造成角度噪声。

建议加一个更温和的门控：

* 若过去 1–2 秒内 `std(g)` 或 `std(roll/pitch)` 很大（手机在明显移动），则**暂停判定**（不进入也不退出，只保持当前状态或回到“未知”）。

---

# 第三层（让“自定义姿势”真的好用）：把“一次录制一个点”升级为“一个姿势多样本 + 角度相似度”

你自定义姿势现在是：录制约 1 秒（≥30 样本）得到一个 `avgNx/avgNy/avgNz`，再把最后一帧 rawAx/rawAy/rawAz 也存进去，相似度用加权欧氏距离（0.7/0.3），阈值 `bestSimilarity < 0.5` 判匹配。

这里有两个高概率误判点：

## 2.6 不要把 rawAx/rawAy/rawAz 作为“相似度主力”

raw 加速度里混了**手抖/微动/走路**，同一姿势在不同情境下 raw 会差很多；反而重力方向（或角度）更稳定。
建议：

* raw 距离权重从 0.3 降到 0.05–0.1，甚至直接去掉
* 或者把 raw 先做“去重力 / 线性加速度分离”（需要 TYPE_LINEAR_ACCELERATION 或融合算法）

## 2.7 用“角度/余弦相似度”替代欧氏距离阈值 0.5（更可解释、更稳）

对两个单位向量 `u`（当前重力方向）和 `v`（录制重力方向）：

* `cos = dot(u, v)`
* `angle = arccos(clamp(cos))`（0°越像）

然后阈值用“角度”更直观：

* `angle < 18°` 判匹配（示例）
* 每个自定义姿势允许用户调“严格/宽松”

这比“0.5”这种无量纲距离更容易调参、也更容易给用户做“灵敏度滑条”。

## 2.8 自定义姿势录制：从“录一次”变成“录 3 次取簇”

同一姿势，用户手会有自然摆动。你现在只取 1 秒平均，很容易“点太尖”，导致误判或漏判。

建议 UI 上让用户录制同一姿势 2–3 次：

* 保存为同一姿势的多个 prototype（或保存均值+方差）
* 匹配时取最小角度/最小马氏距离（有方差时更强）

---

## 3) 体验层补强：用“置信度”和“用户反馈闭环”继续压误判

你现在提醒逻辑是“进入侧躺后开始计时，达到阈值就提醒”，前台还会每秒弹 UI。为了让误判对体验的伤害更小，建议加两点：

### 3.1 引入“置信度”状态，而不是二值 isSide

比如：

* `NORMAL / MAYBE_RISK / RISK_CONFIRMED`
* 只有 `RISK_CONFIRMED` 才开始累计 `sideLyingSince`（你现在是稳定确认进入就记录）

这样即使偶发误判，也更难走到“开始计时→提醒”。

### 3.2 弹窗加一个“误判/我没躺用”按钮，反向学习

用户点一次“误判”，你就把当前角度（roll/pitch）记录为“非风险样本”，用于：

* 动态收紧阈值（或提高 enterHoldMs）
* 或在未来几分钟内对相近角度做抑制（短期个性化）

这对不同用户习惯差异非常有用，而且不需要引入额外传感器权限。

---

## 4) 一句话总结你最该改哪里

* **默认算法的核心特征要换**：从现在这种“非平放 ≈ 侧躺”，升级为“角度（roll/pitch）+ 滞回 + 时间稳定”。
* **加场景门控**：只在“用户确实在用手机”时判定（屏幕/触摸/近脸/低运动），误判会立刻下降一个数量级。
* **自定义姿势用角度相似度 + 多样本**：比“加权欧氏距离阈值 0.5”更稳、更好调。

