# 系统级悬浮窗方案实现说明

## 方案概述

为了解决Android后台监测的问题，我们实现了**系统级悬浮窗方案**，类似百度地图的悬浮球设计。当应用进入后台时，显示一个圆形小助手悬浮窗，可以在其他应用上显示，从而可以持续监测用户姿势。

## 技术实现

### 原生Android实现
- 使用 `WindowManager` 和 `TYPE_APPLICATION_OVERLAY` 创建系统级悬浮窗
- 通过 `FloatingWindowService` 服务管理悬浮窗生命周期
- 使用 Platform Channel 实现 Flutter 与原生代码通信

## 方案优势

1. **避免后台服务限制**：不需要复杂的后台服务，避免系统限制和崩溃问题
2. **用户体验友好**：悬浮窗设计精美，类似百度地图，用户接受度高
3. **实时状态反馈**：悬浮窗可以实时显示监测状态（正常/侧躺）
4. **交互简单**：用户可以拖动悬浮窗，长按可以停止监测

## 实现细节

### 1. 权限配置

在 `AndroidManifest.xml` 中添加了悬浮窗权限：
```xml
<uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
```

### 2. 原生悬浮窗服务

创建了 `FloatingWindowService.kt` 服务类，特点：
- **系统级悬浮窗**：使用 `TYPE_APPLICATION_OVERLAY` 类型，可在其他应用上显示
- **圆形设计**：200x200像素的圆形悬浮球
- **状态指示**：
  - 正常状态：绿色，显示星星图标，显示"监测中"
  - 侧躺状态：紫色，显示恢复图标，显示"侧躺中"
- **交互功能**：
  - 可拖动：用户可以自由拖动悬浮窗位置
  - 点击：打开应用主界面

### 3. Platform Channel 通信

在 `MainActivity.kt` 中实现了以下方法：
- `checkOverlayPermission()`: 检查悬浮窗权限
- `requestOverlayPermission()`: 请求悬浮窗权限
- `showFloatingWindow()`: 显示悬浮窗
- `hideFloatingWindow()`: 隐藏悬浮窗
- `updateFloatingWindowState()`: 更新悬浮窗状态

### 4. Flutter 集成

在 Flutter 代码中创建了 `FloatingWindowManager` 类：
- 封装了所有 Platform Channel 调用
- 提供权限检查和请求功能
- 自动处理权限未授予的情况

### 5. 生命周期管理

修改了应用生命周期逻辑：
- **进入后台**：如果监测开启，自动显示悬浮窗
- **回到前台**：自动隐藏悬浮窗
- **停止监测**：自动隐藏悬浮窗

### 6. 状态同步

悬浮窗会实时反映监测状态：
- 当检测到侧躺时，悬浮窗会变为紫色并显示"侧躺中"
- 当恢复正常姿势时，悬浮窗会变回绿色并显示"监测中"
- 通过 `updateFloatingWindowState()` 方法实时更新

## 使用说明

1. **开启监测**：在应用首页点击"开始监测"按钮
2. **进入后台**：当应用进入后台时，会自动显示悬浮窗
3. **查看状态**：悬浮窗颜色和图标会反映当前监测状态
4. **停止监测**：长按悬浮窗，选择"停止"即可停止监测

## 注意事项

1. **权限要求**：首次使用可能需要用户手动授予悬浮窗权限（Android 6.0+）
2. **系统限制**：部分厂商ROM可能对悬浮窗有限制，需要用户手动允许
3. **电池优化**：建议用户在系统设置中关闭应用的电池优化，确保正常运行

## 与后台服务方案的对比

| 特性 | 后台服务方案 | 系统级悬浮窗方案 ✅ |
|------|------------|-----------------|
| 系统限制 | 严格，容易被系统终止 | 较少，保持前台运行 |
| 崩溃风险 | 较高（传感器权限等） | 较低 |
| 用户体验 | 仅通知栏显示 | 可视化悬浮窗，可在其他应用上显示 |
| 实现复杂度 | 高（需要原生代码） | 高（需要原生代码） |
| 状态反馈 | 无 | 实时可视化 |
| 跨应用显示 | 否 | 是 ✅ |

## 已实现的功能

✅ **系统级悬浮窗**：已实现真正的系统级悬浮窗，可在其他应用上显示
✅ **权限管理**：自动检查和请求悬浮窗权限
✅ **状态同步**：实时更新悬浮窗状态（正常/侧躺）
✅ **拖动功能**：用户可以自由拖动悬浮窗位置
✅ **点击交互**：点击悬浮窗可打开应用主界面

## 后续优化建议

1. **更多交互**：可以添加长按悬浮窗显示统计信息、快速设置等功能
2. **自定义样式**：允许用户自定义悬浮窗的大小、颜色、位置等
3. **动画效果**：添加更流畅的动画效果，提升用户体验
4. **多状态显示**：可以显示更多状态信息，如监测时长、提醒次数等

