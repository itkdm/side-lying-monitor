# 自定义姿势监测功能说明

> **功能完成时间**：2025-01-28  
> **功能描述**：允许用户添加自定义姿势，使用用户数据来完善检测算法

---

## ✅ 已完成的功能

### 1. 数据模型
- ✅ `CustomPosture` - 自定义姿势数据模型
- ✅ 包含归一化向量和原始加速度数据
- ✅ 支持相似度计算

### 2. 数据管理
- ✅ `CustomPostureRepository` - 自定义姿势仓库
- ✅ 支持添加、删除、查询自定义姿势
- ✅ 支持启用/禁用自定义姿势检测
- ✅ 数据持久化存储（SharedPreferences）

### 3. 用户界面
- ✅ `CustomPosturePage` - 添加自定义姿势页面
  - 实时显示传感器数据
  - 记录姿势数据（至少30个样本）
  - 保存自定义姿势
- ✅ `SettingsPage` - 设置页面集成
  - 开关：启用/禁用自定义姿势检测
  - 列表：显示已保存的自定义姿势
  - 操作：添加姿势、删除姿势、恢复默认算法

### 4. 检测算法集成
- ✅ 原生服务集成自定义姿势检测
- ✅ 支持切换默认算法和自定义算法
- ✅ 使用相似度匹配（欧氏距离）

---

## 📝 使用说明

### 添加自定义姿势

1. 打开应用，进入设置页面
2. 找到"自定义姿势监测"部分
3. 点击"添加姿势"按钮
4. 在添加页面：
   - 输入姿势名称（如"左侧躺"、"右侧躺"等）
   - 保持你想要的姿势
   - 点击"开始记录"
   - 保持姿势3-5秒
   - 点击"停止记录"
   - 点击"保存姿势"

### 启用自定义姿势检测

1. 在设置页面找到"自定义姿势监测"
2. 打开开关启用自定义姿势检测
3. 应用将使用你添加的自定义姿势数据进行检测

### 恢复默认算法

1. 在设置页面找到"自定义姿势监测"
2. 点击"恢复默认"按钮
3. 确认清除所有自定义姿势
4. 应用将恢复使用默认系统检测算法

---

## 🔧 技术实现

### 相似度计算

使用欧氏距离计算当前传感器数据与自定义姿势的相似度：

```dart
similarity = normalizedDistance * 0.7 + rawDistance * 0.3
```

- `normalizedDistance`: 归一化向量的欧氏距离（权重0.7）
- `rawDistance`: 原始加速度的欧氏距离（权重0.3）
- 阈值：0.5（相似度低于此值认为是匹配）

### 数据同步

- Flutter层：`CustomPostureRepository` 管理数据
- 原生层：通过 `MethodChannel` 同步数据
- 检测：原生服务 `FloatingWindowService` 执行检测

---

## 📊 数据存储

- **存储位置**：SharedPreferences
- **键名**：
  - `use_custom_postures`: 是否使用自定义姿势
  - `custom_postures`: JSON格式的自定义姿势列表

---

## ⚠️ 注意事项

1. **数据隐私**：所有自定义姿势数据仅保存在本地，不会上传
2. **数据准确性**：建议记录3-5秒以获得更准确的数据
3. **算法切换**：可以随时在自定义算法和默认算法之间切换
4. **数据清理**：卸载应用或点击"恢复默认"会清除所有自定义姿势

---

## 🎯 未来优化方向

1. **机器学习**：使用收集的用户数据训练模型
2. **姿势分类**：支持多种姿势类型（左侧躺、右侧躺等）
3. **数据可视化**：显示传感器数据图表
4. **批量导入/导出**：支持备份和恢复自定义姿势

