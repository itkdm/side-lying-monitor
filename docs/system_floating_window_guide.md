# 系统级悬浮窗使用指南

## 功能说明

系统级悬浮窗可以在应用进入后台时，在其他应用上显示一个圆形小助手，持续监测用户姿势。

## 使用步骤

### 1. 首次使用

1. **开启监测**：在应用首页点击"开始监测"按钮
2. **授予权限**：当应用进入后台时，会自动弹出权限请求对话框
3. **前往设置**：点击"去设置"按钮，跳转到系统设置页面
4. **允许悬浮窗**：在设置中找到"在其他应用上层显示"选项，开启权限
5. **返回应用**：返回应用后，悬浮窗会自动显示

### 2. 日常使用

- **自动显示**：当应用进入后台且监测开启时，悬浮窗会自动显示
- **自动隐藏**：当应用回到前台时，悬浮窗会自动隐藏
- **状态显示**：
  - 🟢 绿色 + "监测中" = 正常姿势
  - 🟣 紫色 + "侧躺中" = 检测到侧躺
- **拖动位置**：可以拖动悬浮窗到屏幕任意位置
- **点击打开**：点击悬浮窗可以快速打开应用主界面

### 3. 停止监测

- 在应用主界面点击"停止监测"按钮
- 悬浮窗会自动隐藏

## 权限说明

### 为什么需要悬浮窗权限？

悬浮窗权限允许应用在其他应用上显示内容，这对于后台监测至关重要：
- 保持应用在前台运行，避免被系统终止
- 实时显示监测状态，让用户了解当前姿势
- 提供快速访问应用的入口

### 如何授予权限？

1. **自动请求**：应用会在需要时自动弹出权限请求对话框
2. **手动设置**：
   - 打开系统设置
   - 找到"应用"或"应用管理"
   - 找到"枕边哨"应用
   - 进入"权限"或"其他权限"
   - 开启"在其他应用上层显示"或"悬浮窗"权限

### 不同厂商的设置路径

- **小米/红米**：设置 → 应用 → 权限管理 → 其他权限 → 显示悬浮窗
- **华为/荣耀**：设置 → 应用 → 应用管理 → 权限 → 悬浮窗
- **OPPO/一加**：设置 → 应用管理 → 应用权限 → 其他权限 → 悬浮窗
- **vivo**：设置 → 应用与权限 → 权限管理 → 其他权限 → 悬浮窗
- **三星**：设置 → 应用 → 特殊访问权限 → 在其他应用上层显示

## 常见问题

### Q1: 悬浮窗不显示？

**可能原因：**
1. 权限未授予：检查系统设置中的悬浮窗权限
2. 电池优化：部分厂商需要关闭电池优化
3. 自启动权限：部分厂商需要开启自启动权限

**解决方法：**
1. 检查并授予悬浮窗权限
2. 在系统设置中关闭应用的电池优化
3. 在系统设置中开启应用的自启动权限

### Q2: 悬浮窗被系统关闭？

**可能原因：**
- 系统内存不足
- 电池优化策略
- 厂商ROM限制

**解决方法：**
- 关闭其他应用释放内存
- 关闭应用的电池优化
- 将应用添加到白名单

### Q3: 悬浮窗影响其他应用使用？

**解决方法：**
- 可以拖动悬浮窗到屏幕边缘
- 点击悬浮窗可以快速打开应用并隐藏悬浮窗
- 在应用主界面停止监测，悬浮窗会自动隐藏

## 技术细节

### 实现原理

1. **原生服务**：使用 Android `Service` 创建后台服务
2. **系统窗口**：使用 `WindowManager` 和 `TYPE_APPLICATION_OVERLAY` 创建系统级窗口
3. **Platform Channel**：通过 Flutter Platform Channel 实现 Flutter 与原生代码通信
4. **状态同步**：实时更新悬浮窗状态，反映当前监测结果

### 性能优化

- 悬浮窗使用轻量级布局，减少资源消耗
- 状态更新采用事件驱动，避免频繁刷新
- 服务使用 `START_STICKY` 标志，确保服务重启

## 隐私说明

- 悬浮窗仅显示监测状态，不收集任何个人信息
- 所有数据仅保存在本地设备
- 不会上传任何数据到服务器

